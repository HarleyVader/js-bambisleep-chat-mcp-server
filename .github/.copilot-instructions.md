# Copilot Instructions for MCP Server & Agent Docking Project

## Project Overview

This is a Model Context Protocol (MCP) server with agent docking capabilities. The project enables secure authentication, tool management, GitHub integration, and real-time communication between agents and the MCP server.

## üåê Live Deployment Environment

The project is currently deployed and accessible at: **https://bambisleep.chat**

### Production Features:
- üîê Dual OAuth Authentication (GitHub + Patreon)
- üí¨ Real-time Chat with Dr. Girlfriend Agent
- üé® Patreon Integration & Patron Verification
- üì° MCP Server with Agent Docking
- üîÑ Socket.IO Real-time Communication
- üá¶üáπ Austrian GDPR Compliance

### Live API Endpoints:
- `GET /health` - Health Check
- `GET /auth/github` - GitHub OAuth
- `GET /auth/patreon` - Patreon OAuth
- `POST /webhooks/patreon` - Patreon Webhooks
- `GET /api/mcp` - MCP Server API
- `GET /api/dock` - Agent Docking
- `WS /socket.io` - Real-time Communication

## 4-Step Development Strategy for Live Environment

When working on this project, follow this systematic approach that includes live deployment testing:

### Step 1: Analysis & Planning
**Think about a solution after reading the #codebase then write development-plan.md file**

1. **Read the codebase thoroughly**
   - Examine existing file structure and dependencies
   - Understand current implementation state
   - Identify what's been completed vs. what needs work
   - Review any existing documentation

2. **Analyze the requirements**
   - Break down the user's request into specific technical requirements
   - Identify which components need to be created, modified, or integrated
   - Consider dependencies and prerequisites
   - **Check live deployment at https://bambisleep.chat for current state**

3. **Plan the implementation**
   - Reference the DEVELOPMENT-PLAN.md for the overall roadmap
   - Determine which week/phase the current task belongs to
   - Plan the specific steps needed to implement the feature
   - Consider testing and validation requirements
   - **Plan deployment testing strategy**

### Step 2: Implementation
**Read #codebase & compare with development-plan.md then implement development-plan.md**

1. **Cross-reference with development plan**
   - Ensure the implementation aligns with the planned architecture
   - Follow the weekly milestones and key tools specified
   - Maintain consistency with the overall project structure

2. **Implement incrementally**
   - Start with core functionality
   - Add features in logical order based on dependencies
   - Test each component as you build it
   - Follow the project's coding standards and patterns

3. **Validate against milestones**
   - Ensure each implementation meets the defined milestone criteria
   - Test functionality works as expected
   - Verify integration with existing components

### Step 3: Live Deployment Testing
**Test changes against the live environment at https://bambisleep.chat**

1. **Pre-deployment validation**
   - Verify all environment variables are properly configured
   - Test OAuth flows with GitHub and Patreon
   - Validate MCP server endpoints and agent docking
   - Check Socket.IO real-time communication

2. **Live environment testing**
   - Test authentication flows on the live site
   - Verify API endpoint functionality using live URLs
   - Test real-time features and WebSocket connections
   - Validate GDPR compliance features
   - Check responsive design and user experience

3. **Production monitoring**
   - Monitor deployment logs and error rates
   - Validate performance metrics
   - Check security configurations
   - Verify all integrations work as expected

### Step 4: Completion Tracking
**Update completion-stats.md when done**

1. **Document what was completed**
   - Record which features were implemented
   - Note any deviations from the original plan
   - Document any new dependencies or configurations added

2. **Update project status**
   - Mark completed milestones
   - Update progress percentages for each week
   - Note any blockers or issues encountered

3. **Plan next steps**
   - Identify what needs to be done next
   - Update priorities based on current state
   - Note any technical debt or refactoring needs

## Project Structure & Key Components

### Week 1: Project Setup & Environment
- **Tools**: dotenv, cross-env, concurrently, nodemon
- **Goal**: Basic project structure with development workflow

### Week 2: Authentication & OAuth
- **Tools**: passport, passport-github2, @oauth-everything/passport-patreon, express-session
- **Goal**: User authentication via GitHub and Patreon

### Week 3: MCP Core & Tool Management
- **Tools**: modelcontextprotocol, ajv, fs-extra, child_process
- **Goal**: Core MCP functionality with tool execution

### Week 4: GitHub Integration
- **Tools**: @octokit/rest, simple-git
- **Goal**: Git operations and GitHub API integration

### Week 5: Server Routing & Real-Time Communication
- **Tools**: express/koa, cors, body-parser, helmet, socket.io, eventsource
- **Goal**: HTTP server with WebSocket and SSE support

### Week 6: Persistence, Testing & Deployment
- **Tools**: sqlite3/pg/redis, sequelize/knex, jest, supertest, eslint, prettier, Docker
- **Goal**: Database, testing, and deployment infrastructure

## Development Guidelines

### Code Quality
- Use ESLint and Prettier for consistent formatting
- Follow the established project structure
- Write comprehensive tests for new functionality
- Document all public APIs and complex logic

### Security Considerations
- Never commit secrets or API keys
- Use environment variables for all configuration
- Follow OWASP guidelines for authentication and session management
- Validate all inputs and sanitize outputs

### Architecture Patterns
- **Monorepo Structure**: Separate server and agent codebases
- **Modular Design**: Each week's components should be loosely coupled
- **Event-Driven**: Use WebSocket/SSE for real-time communication
- **RESTful APIs**: Follow REST principles for HTTP endpoints

### Testing Strategy
- Unit tests for core logic
- Integration tests for API endpoints
- End-to-end tests for critical workflows
- Mock external dependencies (GitHub API, OAuth providers)
- **Live deployment testing on https://bambisleep.chat**
- **Production environment validation**
- **Real-user authentication flow testing**

## Common Development Scenarios

### Adding a New MCP Tool
1. Define JSON schema in the MCP core module
2. Implement tool execution logic
3. Add validation using ajv
4. Write tests for the tool
5. Update tool registry

### Adding a New API Endpoint
1. Define route in appropriate module
2. Add input validation middleware
3. Implement business logic
4. Add error handling
5. Write integration tests

### Adding OAuth Provider
1. Install appropriate passport strategy
2. Configure strategy in auth module
3. Add callback routes
4. Update session handling
5. Test authentication flow

## File Organization

```
js-bambisleep-chat-mcp-server/
‚îú‚îÄ‚îÄ server/                 # MCP Server implementation
‚îú‚îÄ‚îÄ agent/                 # GitHub integration agent
‚îú‚îÄ‚îÄ shared/                # Shared utilities and types
‚îú‚îÄ‚îÄ docker/                # Docker configurations
‚îú‚îÄ‚îÄ DEVELOPMENT-PLAN.md    # This roadmap document
‚îú‚îÄ‚îÄ COMPLETION-STATS.md    # Progress tracking
‚îî‚îÄ‚îÄ .env.example          # Environment template
```

## Environment Variables

Ensure these are configured for development and production:

```bash
# OAuth Configuration
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
PATREON_CLIENT_ID=your_patreon_client_id
PATREON_CLIENT_SECRET=your_patreon_client_secret

# Database
DATABASE_URL=sqlite://./dev.db

# Session
SESSION_SECRET=your_session_secret

# MCP Configuration
MCP_PORT=3001
AGENT_PORT=3002

# Production Configuration
NODE_ENV=production
PORT=443
DOMAIN=bambisleep.chat
SSL_CERT_PATH=/path/to/cert
SSL_KEY_PATH=/path/to/key
```

## Live Deployment Testing Procedures

### Authentication Testing
1. **GitHub OAuth Flow**
   - Navigate to https://bambisleep.chat/auth/github
   - Complete OAuth authorization
   - Verify successful redirect and session creation
   - Test logout functionality

2. **Patreon OAuth Flow**
   - Navigate to https://bambisleep.chat/auth/patreon
   - Complete OAuth authorization
   - Verify patron verification and tier detection
   - Test subscription webhook handling

### API Endpoint Testing
```bash
# Health Check
curl https://bambisleep.chat/health

# MCP Server API
curl https://bambisleep.chat/api/mcp

# Agent Docking API
curl https://bambisleep.chat/api/dock
```

### Real-time Communication Testing
1. **Socket.IO Connection**
   - Connect to wss://bambisleep.chat/socket.io
   - Test agent docking events
   - Verify real-time chat functionality
   - Test Dr. Girlfriend agent responses

2. **WebSocket Stability**
   - Test connection persistence
   - Verify reconnection handling
   - Check message delivery guarantees

## Common Commands

```bash
# Development
npm run dev          # Start both server and agent with hot-reload
npm run test         # Run all tests
npm run lint         # Lint all code
npm run format       # Format code with Prettier

# Production
npm run build        # Build for production
npm run start        # Start production server
docker-compose up    # Start with Docker

# Live Deployment Testing
npm run test:live    # Run tests against live deployment
npm run validate:prod # Validate production environment
curl https://bambisleep.chat/health # Quick health check
```

## Live Environment Monitoring

### Key Metrics to Monitor
- Authentication success rates (GitHub & Patreon)
- API response times and error rates
- WebSocket connection stability
- Agent docking success rates
- GDPR compliance audit logs

### Debugging Production Issues
1. **Check live endpoint status**: https://bambisleep.chat/health
2. **Monitor authentication flows**: Check OAuth redirect chains
3. **Validate WebSocket connections**: Test real-time features
4. **Review agent docking logs**: Monitor MCP server integration
5. **Check GDPR compliance**: Verify data handling procedures

Remember: Always follow the 4-step strategy including live deployment testing for any development work on this project!
